#!/usr/bin/env ruby
require_relative '../app/services/tmdb_movie_importer'
require_relative '../app/services/pretty_logger'
require_relative '../app/services/import_config'
require_relative '../app/services/tui'
include ImportConfig

if __FILE__ == $PROGRAM_NAME
  unless system('command -v mediainfo > /dev/null 2>&1')
    PrettyLogger.error("'mediainfo' command-line tool not found. Please install it first.")
    exit 1
  end

  movie_directory = ARGV[0]
  unless movie_directory && File.directory?(movie_directory)
    puts "Usage: #{$0} [path_to_movie_directory]"
    exit 1
  end

  importer = nil
  begin
    puts "\e[36m╔════════════════════════════════════════╗\e[0m"
    puts "\e[36m║    TMDB Movie Importer               ║\e[0m"
    puts "\e[36m╚════════════════════════════════════════╝\e[0m"
    puts
    puts "Importing from:   \e[33m#{File.absolute_path(movie_directory)}\e[0m"
    puts "Media storage:    \e[33m#{MEDIA_BASE_DIR}\e[0m"
    puts "Background Threads: \e[33m#{MAX_BG_THREADS}\e[0m"

    importer = TMDBMovieImporter.new
    importer.import_from_directory(movie_directory)
  rescue Interrupt
    puts "\n\n[\e[33mWARN\e[0m] Import interrupted by user. Shutting down gracefully..."
    TUI.finish if TUI.active?
    exit 130
  rescue => e
    PrettyLogger.error("A fatal error occurred: #{e.message}")
    PrettyLogger.debug(e.backtrace.join("\n"))
    TUI.finish if TUI.active?
    exit 1
  ensure
    importer&.shutdown
    PrettyLogger.display_summary
  end
end
